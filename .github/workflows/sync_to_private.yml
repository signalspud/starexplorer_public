name: Sync Public Issues to Private

permissions:
  contents: write
  actions: read
  issues: write

on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  issue_comment:
    types: [created]

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Extract mirrored private issue number
        id: extract
        run: |
          BODY="${{ github.event.issue.body }}"
          MATCH=$(printf '%s\n' "$BODY" | grep -o '<!-- mirrored-private: [0-9]* -->' | grep -o '[0-9]*' || true)
          echo "private=${MATCH:-}" >> "$GITHUB_OUTPUT"

      - name: Create private issue if missing
        if: steps.extract.outputs.private == ''
        run: |
          TITLE="${{ github.event.issue.title }}"
          BODY=$(printf "%s\n%s\n\n---\n%s" \ "<!-- mirrored-public: ${{ github.event.issue.number }} -->" \ "Mirrored from public issue: ${{ github.event.issue.html_url }}" \ "${{ github.event.issue.body }}" )
          
          ISSUE_JSON=$(jq -n \
            --arg title "$TITLE" \
            --arg body "$BODY" \
            '{title: $title, body: $body}')

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/signalspud/starexplorer/issues \
            -d "$ISSUE_JSON")

          NEW_NUMBER=$(echo "$RESPONSE" | jq -r '.number')
          echo "private=$NEW_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Update private issue if exists
        if: steps.extract.outputs.private != ''
        run: |
          TITLE="${{ github.event.issue.title }}"
          BODY=$(printf "%s\n%s\n\n---\n%s" \ "<!-- mirrored-public: ${{ github.event.issue.number }} -->" \ "Mirrored from public issue: ${{ github.event.issue.html_url }}" \ "${{ github.event.issue.body }}" )
          
          ISSUE_JSON=$(jq -n \
            --arg title "$TITLE" \
            --arg body "$BODY" \
            '{title: $title, body: $body}')

          curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/signalspud/starexplorer/issues/${{ steps.extract.outputs.private }} \
            -d "$ISSUE_JSON"

      - name: Sync labels
        if: steps.extract.outputs.private != ''
        run: |
          LABELS=$(printf '%s\n' "${{ toJson(github.event.issue.labels) }}" | jq '[.[].name]')
          JSON=$(jq -n --argjson labels "$LABELS" '{labels: $labels}')

          curl -s -X PUT \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/signalspud/starexplorer/issues/${{ steps.extract.outputs.private }}/labels \
            -d "$JSON"

      - name: Sync open/closed state
        if: steps.extract.outputs.private != ''
        run: |
          STATE="${{ github.event.issue.state }}"
          JSON=$(jq -n --arg state "$STATE" '{state: $state}')

          curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/signalspud/starexplorer/issues/${{ steps.extract.outputs.private }} \
            -d "$JSON"

      - name: Mirror comments with dedup
        if: github.event_name == 'issue_comment' && steps.extract.outputs.private != ''
        run: |
          PREFIX="**Public comment by @${{ github.actor }}**"
          COMMENT_BODY="${PREFIX}\n\n${{ github.event.comment.body }}"
          TARGET_REPO="signalspud/starexplorer"
          TARGET_ISSUE="${{ steps.extract.outputs.private }}"

          # Fetch existing comments and check for duplicate body
          EXISTING=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${TARGET_REPO}/issues/${TARGET_ISSUE}/comments")

          DUPLICATE=$(echo "$EXISTING" | jq --arg body "$COMMENT_BODY" '
            map(select(.body == $body)) | length > 0
          ')

          if [ "$DUPLICATE" = "true" ]; then
            echo "Comment already mirrored, skipping."
            exit 0
          fi

          JSON=$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')

          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${TARGET_REPO}/issues/${TARGET_ISSUE}/comments" \
            -d "$JSON"

name: Sync Public Issues to Private

permissions:
  contents: write
  actions: read
  issues: write

on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  issue_comment:
    types: [created]

jobs:
  sync:
    runs-on: ubuntu-latest
    if: >-
      github.actor != 'github-actions[bot]'
      && github.event.sender.type != 'Bot'

    steps:
      - name: Skip if mirrored from private
        id: guard
        run: |
          set -euo pipefail
          BODY="${{ github.event.issue.body }}"
          if printf '%s\n' "$BODY" | grep -q 'Mirrored from private issue'; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Issue originated from private repo, skipping."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract mirrored private issue number
        if: steps.guard.outputs.skip != 'true'
        id: extract
        run: |
          set -euo pipefail

          BODY="${{ github.event.issue.body }}"

          # Extract ALL matches, then pick the FIRST clean numeric one
          MATCH=$(printf '%s\n' "$BODY" \
            | grep -o '<!-- mirrored-private: [0-9]\+ -->' \
            | grep -o '[0-9]\+' \
            | head -n 1 \
            || true)

          # If MATCH contains anything other than digits, clear it
          if ! printf '%s' "$MATCH" | grep -Eq '^[0-9]+$'; then
            MATCH=""
          fi

          printf 'private=%s\n' "$MATCH" >> "$GITHUB_OUTPUT"

      - name: Create private issue if missing
        if: steps.guard.outputs.skip != 'true' && steps.extract.outputs.private == '' && github.event_name == 'issues'
        id: create
        run: |
          set -euo pipefail

          retry() {
            local n=0
            local max=3
            local delay=2
            until [ "$n" -ge "$max" ]; do
              "$@" && return 0 || {
                n=$((n+1))
                echo "Retry $n/$max failed, retrying in ${delay}s..." >&2
                sleep "$delay"
              }
            done
            return 1
          }

          TITLE="${{ github.event.issue.title }}"
          BODY=$(printf "%s\n%s\n\n---\n%s" \
            "<!-- mirrored-public: ${{ github.event.issue.number }} -->" \
            "Mirrored from public issue: ${{ github.event.issue.html_url }}" \
            "${{ github.event.issue.body }}")

          ISSUE_JSON=$(jq -n \
            --arg title "$TITLE" \
            --arg body "$BODY" \
            '{title: $title, body: $body}')

          RESPONSE=$(retry curl -sS -X POST \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/signalspud/starexplorer/issues \
            -d "$ISSUE_JSON")

          NEW_NUMBER=$(printf '%s' "$RESPONSE" | jq -r '.number // empty')

          if ! printf '%s' "$NEW_NUMBER" | grep -Eq '^[0-9]+$'; then
            echo "Error: GitHub API did not return a valid issue number" >&2
            echo "Response was:" >&2
            printf '%s\n' "$RESPONSE" >&2
            exit 1
          fi

          printf 'private=%s\n' "$NEW_NUMBER" >> "$GITHUB_OUTPUT"

          # Write backlink into the public issue body so future events find it
          CURRENT_BODY="${{ github.event.issue.body }}"
          UPDATED_BODY=$(printf '%s\n%s' "<!-- mirrored-private: ${NEW_NUMBER} -->" "$CURRENT_BODY")
          UPDATE_JSON=$(jq -n --arg body "$UPDATED_BODY" '{body: $body}')

          retry curl -sS -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}" \
            -d "$UPDATE_JSON"

      - name: Resolve private issue number
        if: steps.guard.outputs.skip != 'true'
        id: resolve
        run: |
          set -euo pipefail
          PRIVATE="${{ steps.extract.outputs.private }}"
          if [ -z "$PRIVATE" ]; then
            PRIVATE="${{ steps.create.outputs.private }}"
          fi
          printf 'private=%s\n' "$PRIVATE" >> "$GITHUB_OUTPUT"

      - name: Update private issue if exists
        if: steps.guard.outputs.skip != 'true' && steps.extract.outputs.private != '' && github.event_name == 'issues'
        run: |
          set -euo pipefail

          retry() {
            local n=0
            local max=3
            local delay=2
            until [ "$n" -ge "$max" ]; do
              "$@" && return 0 || {
                n=$((n+1))
                echo "Retry $n/$max failed, retrying in ${delay}s..." >&2
                sleep "$delay"
              }
            done
            return 1
          }

          TITLE="${{ github.event.issue.title }}"
          BODY=$(printf "%s\n%s\n\n---\n%s" \
            "<!-- mirrored-public: ${{ github.event.issue.number }} -->" \
            "Mirrored from public issue: ${{ github.event.issue.html_url }}" \
            "${{ github.event.issue.body }}")

          ISSUE_JSON=$(jq -n \
            --arg title "$TITLE" \
            --arg body "$BODY" \
            '{title: $title, body: $body}')

          retry curl -sS -X PATCH \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/signalspud/starexplorer/issues/${{ steps.extract.outputs.private }}" \
            -d "$ISSUE_JSON"

      - name: Sync labels
        if: steps.guard.outputs.skip != 'true' && steps.resolve.outputs.private != '' && github.event_name == 'issues'
        run: |
          set -euo pipefail

          retry() {
            local n=0
            local max=3
            local delay=2
            until [ "$n" -ge "$max" ]; do
              "$@" && return 0 || {
                n=$((n+1))
                echo "Retry $n/$max failed, retrying in ${delay}s..." >&2
                sleep "$delay"
              }
            done
            return 1
          }

          LABELS_JSON=$(printf '%s\n' "${{ toJson(github.event.issue.labels) }}" | jq '[.[].name]')
          JSON=$(jq -n --argjson labels "$LABELS_JSON" '{labels: $labels}')

          retry curl -sS -X PUT \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/signalspud/starexplorer/issues/${{ steps.resolve.outputs.private }}/labels" \
            -d "$JSON"

      - name: Sync open/closed state
        if: steps.guard.outputs.skip != 'true' && steps.resolve.outputs.private != '' && github.event_name == 'issues'
        run: |
          set -euo pipefail

          retry() {
            local n=0
            local max=3
            local delay=2
            until [ "$n" -ge "$max" ]; do
              "$@" && return 0 || {
                n=$((n+1))
                echo "Retry $n/$max failed, retrying in ${delay}s..." >&2
                sleep "$delay"
              }
            done
            return 1
          }

          STATE="${{ github.event.issue.state }}"
          JSON=$(jq -n --arg state "$STATE" '{state: $state}')

          retry curl -sS -X PATCH \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/signalspud/starexplorer/issues/${{ steps.resolve.outputs.private }}" \
            -d "$JSON"

      - name: Mirror comments with hash dedup and loop protection
        if: steps.guard.outputs.skip != 'true' && github.event_name == 'issue_comment' && steps.resolve.outputs.private != ''
        run: |
          set -euo pipefail

          retry() {
            local n=0
            local max=3
            local delay=2
            until [ "$n" -ge "$max" ]; do
              "$@" && return 0 || {
                n=$((n+1))
                echo "Retry $n/$max failed, retrying in ${delay}s..." >&2
                sleep "$delay"
              }
            done
            return 1
          }

          # Prevent loops: if this comment already looks like a mirrored one, bail
          if printf '%s\n' "${{ github.event.comment.body }}" | grep -q '^**Private comment by @'; then
            echo "Comment appears to be a mirrored private comment, skipping to avoid loop."
            exit 0
          fi

          PREFIX="**Public comment by @${{ github.actor }}**"
          RAW_BODY="${{ github.event.comment.body }}"
          COMMENT_BODY=$(printf '%s\n\n%s' "$PREFIX" "$RAW_BODY")

          HASH=$(printf '%s' "$COMMENT_BODY" | sha256sum | cut -d ' ' -f1)
          COMMENT_WITH_HASH=$(printf '%s\n\n<!-- mirror-hash: %s -->' "$COMMENT_BODY" "$HASH")

          TARGET_REPO="signalspud/starexplorer"
          TARGET_ISSUE="${{ steps.resolve.outputs.private }}"

          EXISTING=$(retry curl -sS \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${TARGET_REPO}/issues/${TARGET_ISSUE}/comments")

          DUPLICATE=$(printf '%s' "$EXISTING" | jq --arg hash "$HASH" '
            map(select(.body | contains($hash))) | length > 0
          ')

          if [ "$DUPLICATE" = "true" ]; then
            echo "Comment already mirrored (hash match), skipping."
            exit 0
          fi

          JSON=$(jq -n --arg body "$COMMENT_WITH_HASH" '{body: $body}')

          retry curl -sS -X POST \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_STARS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${TARGET_REPO}/issues/${TARGET_ISSUE}/comments" \
            -d "$JSON"
